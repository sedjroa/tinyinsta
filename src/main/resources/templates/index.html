<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TinyInsta</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: sans-serif; background: #f5f5f5; }
        .container { max-width: 500px; margin: 2em auto; background: #fff; padding: 2em; border-radius: 8px; }
        .post { border-bottom: 1px solid #eee; margin-bottom: 1em; padding-bottom: 1em; }
        img { max-width: 100%; border-radius: 8px; }
        .login, .register { margin-bottom: 1em; }
    </style>
</head>
<body>
<div class="container" x-data="tinyInsta()">
    <template x-if="!userId">
        <div>
            <h2>Connexion</h2>
            <form class="login" @submit.prevent="login">
                <input x-model="loginUser" placeholder="Utilisateur" required>
                <input x-model="loginPass" type="password" placeholder="Mot de passe" required>
                <button type="submit">Se connecter</button>
            </form>
            <h3>Ou s'inscrire</h3>
            <form class="register" @submit.prevent="register">
                <input x-model="registerUser" placeholder="Utilisateur" required>
                <input x-model="registerPass" type="password" placeholder="Mot de passe" required>
                <button type="submit">S'inscrire</button>
            </form>
            <div x-text="error" style="color:red"></div>
        </div>
    </template>
    <template x-if="userId">
        <div>
            <h2>Poster une image</h2>
            <form @submit.prevent="createPost">
                <input type="file" x-ref="file" required>
                <input x-model="description" placeholder="Description">
                <button type="submit">Poster</button>
            </form>
            <button @click="logout">Déconnexion</button>
            <h2>Utilisateurs</h2>
            <div>
                <template x-for="user in allUsers" :key="user.id">
                    <div style="margin-bottom:0.5em">
                        <span x-text="user.username"></span>
                        <template x-if="user.id !== parseInt(userId)">
                            <button @click="toggleFollow(user.id)" x-text="isFollowing(user.id) ? 'Se désuivre' : 'Suivre'"></button>
                        </template>
                    </div>
                </template>
            </div>
            <h2>Fil d'actualité</h2>
            <template x-for="post in posts" :key="post.id">
                <div class="post">
                    <img :src="post.imagePath">
                    <div><b x-text="post.user.username"></b></div>
                    <div x-text="post.description"></div>
                </div>
            </template>
        </div>
    </template>
</div>
<script>
function tinyInsta() {
    return {
        userId: localStorage.getItem('userId'),
        loginUser: '',
        loginPass: '',
        registerUser: '',
        registerPass: '',
        description: '',
    posts: [],
    allUsers: [],
    followees: [],
        error: '',
        async login() {
            this.error = '';
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: this.loginUser, password: this.loginPass})
            });
            if (res.ok) {
                this.userId = await res.text();
                localStorage.setItem('userId', this.userId);
                this.fetchPosts();
            } else {
                this.error = 'Identifiants invalides';
            }
        },
        async register() {
            this.error = '';
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: this.registerUser, password: this.registerPass})
            });
            if (res.ok) {
                this.loginUser = this.registerUser;
                this.loginPass = this.registerPass;
                this.registerUser = '';
                this.registerPass = '';
                await this.login();
            } else {
                this.error = 'Utilisateur déjà existant';
            }
        },
        async createPost() {
            const file = this.$refs.file.files[0];
            if (!file) return;
            const form = new FormData();
            form.append('userId', this.userId);
            form.append('description', this.description);
            form.append('image', file);
            const res = await fetch('/api/posts', {method: 'POST', body: form});
            if (res.ok) {
                this.description = '';
                this.$refs.file.value = '';
                this.fetchPosts();
            }
        },
        async fetchPosts() {
            if (!this.userId) return;
            const res = await fetch('/api/posts?userId=' + this.userId);
            if (res.ok) {
                this.posts = await res.json();
            }
        },
        async fetchAllUsers() {
            const res = await fetch('/api/auth/users');
            if (res.ok) {
                this.allUsers = await res.json();
            }
        },
        async fetchFollowees() {
            if (!this.userId) return;
            const res = await fetch('/api/follow/followees?followerId=' + this.userId);
            if (res.ok) {
                const data = await res.json();
                this.followees = data.map(f => f.followee.id);
            }
        },
        isFollowing(userId) {
            return this.followees.includes(userId);
        },
        async toggleFollow(followeeId) {
            if (this.isFollowing(followeeId)) {
                await fetch('/api/follow/unfollow?followerId=' + this.userId + '&followeeId=' + followeeId, {method: 'POST'});
            } else {
                await fetch('/api/follow/follow?followerId=' + this.userId + '&followeeId=' + followeeId, {method: 'POST'});
            }
            await this.fetchFollowees();
            await this.fetchPosts();
        },
        logout() {
            this.userId = null;
            localStorage.removeItem('userId');
        },
        async init() {
            if (this.userId) {
                await this.fetchAllUsers();
                await this.fetchFollowees();
                await this.fetchPosts();
            }
        }
    }
}
document.addEventListener('alpine:init', () => {
    Alpine.data('tinyInsta', tinyInsta);
});
// Ajout d'un endpoint pour lister tous les users côté backend :
// @GetMapping("/api/auth/users") public List<User> getAllUsers() { return userRepository.findAll(); }
</script>
</body>
</html>
